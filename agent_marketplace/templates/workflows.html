{% extends "layout.html" %}

{% block title %}N8N - Agent Marketplace{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="header">
        <div class="header-top">
            <div class="header-left">
                <!-- Left side content if needed -->
            </div>
            <div class="user-profile" id="userProfile">
                <button id="loginBtn" class="login-btn" onclick="showAuthModal()" style="display: block;">
                    <i class="fas fa-sign-in-alt"></i>
                    Sign In
                </button>
                <div id="userInfo" class="user-info" style="display: none;">
                    <img id="userAvatar" class="user-avatar" src="/static/images/default-avatar.png" alt="" style="width: 32px; height: 32px; border-radius: 50%; margin-right: 10px;">
                    <span id="userName">User</span>
                    <span id="authStatus" style="font-size: 10px; color: #10b981; margin-left: 8px;">‚óè</span>
                    <button id="logoutBtn" onclick="logout()" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill"></div>
        </div>
        
        <h1 class="main-title">N8N <span class="highlight">2</span> MCP</h1>
        <p class="subtitle">Import N8N workflow templates and deploy them as your MCP servers</p>
    </div>

    <!-- Workflow Import Section -->
    <div class="search-section">
        <div class="workflow-import-header">
            <h3>Import N8N Workflow Template</h3>
            <p>Paste an N8N template URL to automatically import and configure the workflow</p>
        </div>
        
        <div class="url-input-section">
            <input type="text" class="search-bar" placeholder="https://n8n.io/workflows/5048-generate-an-ai-summary-of-your-notion-comments/" id="templateUrlInput">
            <button class="import-btn" onclick="importWorkflowFromUrl()">
                <i class="fas fa-download"></i>
                Import Template
            </button>
        </div>

        <div class="or-divider">
            <span>OR</span>
        </div>
        
        <div class="upload-methods">
            <!-- File Upload -->
            <div class="upload-method" id="fileUploadMethod">
                <div class="upload-icon">
                    <i class="fas fa-file-upload"></i>
                </div>
                <h5>Upload JSON File</h5>
                <p>Name your workflow and upload your N8N workflow JSON file</p>
                
                <!-- Workflow Name Input -->
                <div>
                    <label>
                        Workflow Name <span>*</span>
                    </label>
                    <input 
                        type="text" 
                        id="userWorkflowName" 
                        placeholder="Enter a name for your workflow..."
                        required
                    >
                    <small>Give your workflow a descriptive name that you'll recognize later</small>
                </div>
                
                <input type="file" id="workflowFile" accept=".json" style="display: none;" onchange="handleFileUpload(event)">
                <button class="method-btn" onclick="validateAndUploadFile()">
                    <i class="fas fa-folder-open me-2"></i>Browse Files
                </button>
            </div>
            
            <!-- JSON Paste -->
            <div class="upload-method" id="jsonPasteMethod">
                <div class="upload-icon">
                    <i class="fas fa-code"></i>
                </div>
                <h5>Paste JSON</h5>
                <p>Name your workflow and paste your N8N workflow JSON</p>
                
                <!-- Workflow Name Input for JSON Paste -->
                <div>
                    <label>
                        Workflow Name <span>*</span>
                    </label>
                    <input 
                        type="text" 
                        id="jsonWorkflowName" 
                        placeholder="Enter a name for your workflow..."
                        required
                    >
                    <small>Give your workflow a descriptive name that you'll recognize later</small>
                </div>
                
                <button class="method-btn" onclick="showJsonEditor()">
                    <i class="fas fa-edit me-2"></i>Open Editor
                </button>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div class="loading-spinner" id="loadingSpinner" style="display: none;">
        <div class="spinner"></div>
        <h3>Processing workflow...</h3>
        <p>Analyzing nodes and extracting credential requirements</p>
    </div>

    <!-- Streamlined Workflow Configuration -->
    <div class="workflow-configuration" id="workflowConfiguration" style="display: none;">
        <!-- Workflow Info Card -->
        <div class="workflow-info-card">
            <div class="workflow-header">
                <div class="workflow-icon">üîß</div>
                <div class="workflow-details">
                    <h3 id="workflowTitle">Workflow Preview</h3>
                    <p id="workflowDescription"></p>
                </div>
            </div>
            
            <div class="workflow-stats">
                <div class="stat-item">
                    <span class="stat-number" id="nodeCount">0</span>
                    <span class="stat-label">Nodes</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="credentialCount">0</span>
                    <span class="stat-label">Services</span>
                </div>
            </div>
        </div>

        <!-- Credential Configuration Section -->
        <div class="credential-configuration" id="credentialConfiguration">
            <h3>
                <i class="fas fa-key me-2"></i>Configure Credentials
            </h3>
            <p>Set up your API keys and credentials for the workflow services</p>
            <div id="credentialFormContainer"></div>
        </div>

        <!-- Deploy Section -->
        <div class="deploy-section" id="deploySection">
            <div>
                <button onclick="deployWorkflowToN8N()" class="deploy-btn">
                    <i class="fas fa-rocket me-2"></i>Deploy Agent
                </button>
            </div>
        </div>
    </div>

    <!-- Manage Workflows Section -->
    <div class="card">
        <div>
            <div>
                <h2>üîß Manage Workflows</h2>
                <p>Configure and deploy your existing workflows</p>
            </div>
            <button onclick="loadUserUploadedWorkflows()" class="category-btn">
                <i class="fas fa-refresh me-2"></i>Refresh
            </button>
        </div>

        <!-- Workflow Type Tabs -->
        <div class="workflow-tabs">
            <button class="tab-btn active" onclick="switchWorkflowTab('uploaded')" id="uploadedTab">
                <i class="fas fa-upload me-2"></i>My Workflows
            </button>

        </div>

        <!-- Uploaded Workflows Content -->
        <div id="uploadedWorkflowsContent" class="tab-content active">
            <div id="userWorkflowsContainer" class="workflows-grid">
                <!-- User workflows will be loaded here -->
            </div>
        </div>


    </div>

    <!-- MCP Servers Section -->
    <div class="card">
        <div>
            <div>
                <h2>üîó MCP Servers</h2>
                <p>Access your deployed workflow MCP endpoints</p>
            </div>
            <button onclick="loadMCPServers()" class="category-btn">
                <i class="fas fa-refresh me-2"></i>Refresh
            </button>
        </div>

        <div id="mcpServersContainer" class="mcp-servers-grid">
            <!-- MCP servers will be loaded here -->
        </div>
    </div>

    <!-- Credential Configuration Modal (for editing existing workflows) -->
    <div id="credentialModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Configure Workflow Credentials</h2>
                <button class="close-btn" onclick="hideModal('credentialModal')">&times;</button>
            </div>
            
            <div class="modal-body">
                <div id="modalCredentialForm"></div>
            </div>
        </div>
    </div>

    <!-- JSON Editor Modal -->
    <div id="jsonEditorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">N8N Workflow JSON Editor</h2>
                <button class="close-btn" onclick="hideModal('jsonEditorModal')">&times;</button>
            </div>
            
            <div class="modal-body">
                <div>
                    <label>Paste your N8N workflow JSON here:</label>
                    <textarea class="json-editor" id="jsonEditor" placeholder="Paste your N8N workflow JSON here..."></textarea>
                </div>
                <div>
                    <button class="category-btn" onclick="validateJson()">
                        <i class="fas fa-check-circle me-2"></i>Validate JSON
                    </button>
                    <button class="category-btn" onclick="formatJson()">
                        <i class="fas fa-magic me-2"></i>Format JSON
                    </button>
                    <button class="category-btn active" onclick="processJsonFromEditor()">
                        <i class="fas fa-cogs me-2"></i>Process Workflow
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Sign In</h2>
                <button class="close-btn" onclick="hideModal('authModal')">&times;</button>
            </div>
            
            <div class="modal-body">
                <p>
                    Sign in with your preferred social account and manage your workflow credentials
                </p>
                
                <div class="auth-methods">
                    <button class="auth-btn google-btn" onclick="authenticateWith('google')">
                        Continue with Google
                    </button>
                    
                    <button class="auth-btn github-btn" onclick="authenticateWith('github')">
                        Continue with GitHub
                    </button>
                </div>
                
                <p>
                    Your credentials are encrypted and stored securely. We never share your data with third parties.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/workflow-credentials.js') }}"></script>
{% endblock %}
